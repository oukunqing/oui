<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>树形菜单</title>
    <style type="text/css">
        body {background:#fff;margin:0;padding:0;font-size: 14px;font-family: 宋体;}
        .form{background: #fff;overflow: hidden;}
        div{clear:both;overflow:hidden;}
        div.box {border:solid 1px #ccc;border-radius:4px;padding:8px 8px 0;margin:0 0 6px 0;}
        button{ height:30px;line-height:24px; padding:0 6px;font-family: 宋体;font-size:14px;
            display:inline-block;float:left;margin:0 6px 6px 0;cursor: pointer;}
        select {height:30px;border:solid 1px #ccc;border-radius: 4px;float:left;margin:0 6px 6px 0;}
        .txt {height:26px;line-height:26px;border:solid 1px #ccc;text-align:center;font-size:14px;border-radius:4px;}
        .item { padding:0 0 6px 0;}
        .item span,.item button,.item input {float:left;margin:0 6px 6px 0;}
        .item span{line-height:28px;}
        .chb-label {border:solid 1px #ccc;border-radius:4px;box-sizing:border-box;padding:5px 6px 0 2px;height:30px;
            display:inline-block;overflow:hidden;float:left;margin:0 6px 6px 0;}
        .chb-label input{float:left;margin:3px 5px 0 2px;}
        .chb-label span{line-height:18px;margin:0;}
    </style>
</head>
<body>
<div class="form">
    <div style="float:left;padding:6px;clear:none;">
        <div id="tree" style="display:block;border:solid 1px #00f;border-radius:4px;overflow:auto;width:500px;height:600px;margin:0;"></div>
        <div id="txt" style="margin:0;padding:5px 0;"></div>
        <div id="tree1" style="display:block;border:solid 1px #00f;border-radius:4px;overflow:auto;width:500px;height:200px;margin:0;"></div>
    </div>
    <div style="float:left;padding:0;margin:6px 0 0;clear:none;">
        <div class="box">
            <div>
                <label class="chb-label"><input type="checkbox" value="root" name="chbData" checked="checked" /><span>根节点</span></label>
                <label class="chb-label"><input type="checkbox" value="unit" name="chbData" checked="checked" /><span>目录</span></label>
                <label class="chb-label"><input type="checkbox" value="device" name="chbData" /><span>设备</span></label>
                <label class="chb-label"><input type="checkbox" value="camera" name="chbData" /><span>通道</span></label>
                <label class="chb-label"><input type="checkbox" value="department" name="chbData" /><span>部门</span></label>
                <label class="chb-label"><input type="checkbox" value="person" name="chbData" /><span>人员</span></label>
            </div>
            <div class="item">
                <select id="ddlLevel">
                    <option value="-1">全部展开</option>
                    <option value="0">全部收缩</option>
                    <option value="1">展开到1级</option>
                    <option value="2">展开到2级</option>
                    <option value="3">展开到3级</option>
                    <option value="4">展开到4级</option>
                    <option value="5">展开到5级</option>
                    <option value="6">展开到6级</option>
                </select>
                <span>Skin</span>
                <select id="ddlSkin" style="font-size:14px;">
                    <option value="default">Default</option>
                    <option value="device" selected="selected">Device</option>
                    <option value="list">List</option>
                </select>
                <span>Switch</span>
                <select id="ddlSwitch" style="font-size:14px;">
                    <option value="default">Default</option>
                    <option value="device">Device</option>
                    <option value="arrow">Arrow</option>
                </select>
                <label class="chb-label"><input type="checkbox" id="chbCamera" checked="checked" /><span>动态加载通道</span></label>
                <div></div>
                <label class="chb-label"><input type="checkbox" id="chbCheck" checked="checked" /><span>显示选框</span></label>
                <label class="chb-label"><input type="checkbox" id="chbIcon" checked="checked" /><span>显示图标</span></label>
                <label class="chb-label"><input type="checkbox" id="chbCount" checked="checked" /><span>显示数量</span></label>
                <label class="chb-label"><input type="checkbox" id="chbDesc" checked="checked" /><span>显示备注</span></label>
                <label class="chb-label"><input type="checkbox" id="chbSearch" checked="checked" /><span>显示搜索</span></label>
                <label class="chb-label"><input type="checkbox" id="chbTitle" checked="checked" /><span>显示标题</span></label>
                <div></div>
                <label class="chb-label"><input type="checkbox" id="chbInfo" /><span>显示信息</span></label>
                <label class="chb-label"><input type="checkbox" id="chbButton" /><span>显示按钮</span></label>
                <label class="chb-label"><input type="checkbox" id="chbMoveAble" /><span>允许移动</span></label>
                <label class="chb-label"><input type="checkbox" id="chbMove" /><span>显示移动</span></label>
                <label class="chb-label"><input type="checkbox" id="chbDragAble" /><span>允许拖动</span></label>
                <div></div>
                <label class="chb-label"><input type="checkbox" id="chbStatus" checked="checked" /><span>保持状态</span></label>
                <label class="chb-label"><input type="checkbox" id="chbCookie" checked="checked" /><span>保存COOKIE</span></label>
                <label class="chb-label"><input type="checkbox" id="chbClickExpand" checked="checked" /><span>点击切换</span></label>
                <label class="chb-label"><input type="checkbox" id="chbClickChecked" /><span>点击选中</span></label>
                <div>
                    <button onclick="test(0);">加载树菜单</button>
                    <button onclick="test(1);">加载树菜单1</button>
                    <button onclick="test(2);">实时加载树菜单</button>
                    <button onclick="test(3);">加载树菜单(测试)</button>
                </div>
            </div>
        </div>
        <div id="divOper" class="box" style="display:none;">
            <div>
                <label class="chb-label">
                    <input type="checkbox" value="1" id="chbLinkage" checked="checked" />
                    <span>级联</span>
                </label>
                <label class="chb-label">
                    <input type="checkbox" value="1" id="chbReverse" checked="checked" />
                    <span>反转（层级）</span>
                </label>
            </div>
            <div>
                <select id="ddlLevel2" style="width:62px;">
                    <option value="0">0级</option>
                    <option value="1">1级</option>
                    <option value="2">2级</option>
                    <option value="3">3级</option>
                    <option value="4">4级</option>
                    <option value="5">5级</option>
                    <option value="6">6级</option>
                    <option value="7">7级</option>
                </select>
                <button onclick="expandLevel();">按层级展开</button>
                <button onclick="expandLevel(false);">按层级收缩</button>
                <button onclick="expandAll();">全部展开</button>
                <button onclick="expandAll(false);">全部收缩</button>
            </div>
            <div>
                <select id="ddlType2" style="width:62px;">
                    <option value="unit">目录</option>
                    <option value="device">设备</option>
                    <option value="camera">通道</option>
                    <option value="department">部门</option>
                    <option value="person">人员</option>
                </select>
                <button onclick="expandType();">按类型展开</button>
                <button onclick="expandType(false);">按类型收缩</button>
            </div>
            <div>
                <div style="padding:0 0 5px 0;" class="item">
                    <span>原节点ID:</span>
                    <input type="text" id="txtNodeId" class="txt" style="width:180px;" placeholder="是NodeId 不是DataId" />
                    <span>目标节点ID:</span>
                    <input type="text" id="txtDestId" class="txt" style="width:180px;" placeholder="目标NodeId" />
                </div>
                <div style="padding:0 0 5px 0;" class="item">
                    <button onclick="position();">定位</button>
                    <button onclick="position(true);">定位并选中</button>
                    <button onclick="deleteNode();">删除节点</button>
                    <select id="ddlChild">
                        <option value="0">节点</option>
                        <option value="1">子节点</option>
                    </select>
                    <button onclick="moveNode();">移动节点到</button>
                    <button onclick="moveNode(true);">插入节点到</button>
                </div>
                <div style="padding:0 0 5px 0;" class="item">
                    <button onclick="sortUp();">上移</button>
                    <button onclick="sortDown();">下移</button>
                    <label class="chb-label">
                        <input type="checkbox" value="1" id="chbDrag2" />
                        <span>模拟拖动</span>
                    </label>
                    <button onclick="sortNode();">移动位置到</button>
                </div>
                <div style="padding:0 0 5px 0;" class="item">
                    <span>通道ID:</span>
                    <input type="text" id="txtPid" class="txt" style="width:60px;" />
                    <span>数量:</span>
                    <input type="text" id="txtPresetLen" class="txt" style="width:50px;" maxlength="6" />
                    <button onclick="addNode2();">新增预置点</button>
                </div>
                <div>
                    <button onclick="setHeight();">增加高度</button>
                </div>
                
                <!--<button onclick="addNode1();">新增子节点</button>-->
            </div>
        </div>
    </div>
</div>
</body>
</html>
<script type="text/javascript" src="../oui/oui.js?1"></script>
<script type="text/javascript" src="../oui/contextmenu/oui.contextmenu.min.js"></script>
<script type="text/javascript" src="../oui/tree/oui.tree.min.js?123"></script>
<script type="text/javascript" src="dropdownlist.json"></script>
<script type="text/javascript">

    var testData1 = {
        units: [
            {id:1,pid:0,name:'主控制中心<'},
            {id:2,pid:1,name:'中言科技<"'},
            {id:3,pid:1,name:'浙江'},
            {id:4,pid:1,name:'江苏'},
            {id:5,pid:2,name:'演示测试'},
            {id:6,pid:5,name:'演示测试1'},
            {id:7,pid:5,name:'演示测试2'},
            {id:8,pid:2,name:'出厂检测'},
            {id:9,pid:8,name:'出厂检测1'},
            {id:10,pid:8,name:'出厂检测2'},
            {id:12,pid:8,name:'出厂检测3'},
            {id:13,pid:8,name:'出厂检测4'},
            {id:14,pid:8,name:'出厂检测5'},
            {id:15,pid:8,name:'出厂检测6'},
            {id:16,pid:8,name:'出厂检测7'}
        ]
    };

    window.onload = function () {

    };

    var TreeId = 'tree';

    function expandLevel(expand) {
        var linkage = $('#chbLinkage').checked(),
            reverse = $('#chbReverse').checked(),
            level = $('#ddlLevel2').val().toInt();
        $.console.log('expandLevel:', level, linkage, reverse, expand);
        //$.tree() 空参数 可以获取到第一个非空的树，如果当前页面只有一个树，可以这样获取
        $.tree(TreeId).expandLevel(level, linkage, reverse, expand);
    }

    function expandType(expand) {
        var linkage = $('#chbLinkage').checked(),
            type = $('#ddlType2').val();
        $.tree(TreeId).expandType(type, linkage, expand);
    }

    function expandAll(expand) {
        $.tree(TreeId).expandAll(expand);
    }

    function addNode1() {
        var items = [{id:5,name:'部门五',pid:1},{id:6,name:'部门六',pid:1},{id:7,name:"部门七",pid:5}],
            par = {ptype: 'department',type: 'department'};

        $.tree(TreeId).add(items, par);
    }
    function addNode2() {
        var pid = $('#txtPid').val(),
            len = $('#txtPresetLen').val().toInt(1),
            num,
            par = {type: 'preset', ptype: 'camera'},
            items = [],
            nid = $.tree(TreeId).nid(pid, 'camera'),
            node = $.tree(TreeId).node(nid);

        if (!pid || !len || !node) {
            return false;
        }

        num = node.childs.length;

        for (var i = 0; i < len; i++) {
            items.push({id: pid + '_' + (num + i + 1), name: '预置点' + (num + i + 1), pid: pid});
        }
        $.tree(TreeId).add(items, par);
    }

    function setHeight() {
        $('#tree').height($('#tree').height() + 50);
        $.tree().resize();
    }

    function position(selected) {
        var nid = $('#txtNodeId').val().trim();
        $.tree(TreeId).position(nid, selected);
    }

    function deleteNode() {
        var nid = $('#txtNodeId').val().trim(),
            child = $('#ddlChild').val().toInt();

        $.tree(TreeId)[child ? 'deleteChild' : 'delete'](nid);
    }

    function moveNode(insert) {
        var nid = $('#txtNodeId').val().trim(),
            dest = $('#txtDestId').val().trim(),
            child = $('#ddlChild').val().toInt();

        $.tree(TreeId)[child ? 'moveChild' : 'move'](nid, dest, insert);
    }

    function sortUp() {
        var nid = $('#txtNodeId').val().trim();
        $.tree(TreeId).sortUp(nid);
    }

    function sortDown() {
        var nid = $('#txtNodeId').val().trim();
        $.tree(TreeId).sortDown(nid);
    }
    function sortNode() {
        var nid = $('#txtNodeId').val().trim(),
            dest = $('#txtDestId').val().trim(),
            drag = $('#chbDrag2').checked();

        $.tree(TreeId).sortNode(nid, dest, function (node, num, idx) {
            $.console.log('sortNode', node, num, idx);
        }, drag);
    }

    function getTestData(resolve) {
        $.console.log('getTestData:0');
        var data = treedata;
        if ($.isFunction(resolve)) {
            $.console.log('getTestData:1');
            resolve(data);
        }
        $.console.log('getTestData:2');
    }

    var cache = {};

    function test(type) {   
        var arr = $N('chbData'), keys = {};
        for (var i = 0; i < arr.length; i++) {
            if (arr[i].checked) {
                keys[arr[i].value] = 1;
            }
        }

        var trees = [
            keys['root'] ? {type:'root',key:'datas'} : undefined,
            keys['unit'] ? {type:'unit',key:'units',name:'目录'} : undefined,
            keys['device'] ? {type:'device',key:'devices',ptype:'unit',name:'设备'} : undefined,
            keys['camera'] ? {type:'camera',key:'cameras',ptype:'device',name:'通道'} : undefined,
            keys['department'] ? {type:'department',key:'departments'} : undefined,
            keys['person'] ? {type:'helmet',key:'persons',ptype:'department'} : undefined
        ];

        $.console.log('trees:', trees);

        var datas = [treedata, treedata2, getTestData, testData1];

        var html = ['begin: ' + new Date().format('HHmmss.fff') + ', '],
            data = datas[type],
            skin = $('#ddlSkin').val(),
            openLevel = $('#ddlLevel').val().toInt(),
            keepStatus = $('#chbStatus').checked(),
            keepCookie = $('#chbCookie').checked(),
            showCheck = $('#chbCheck').checked(),
            showIcon = $('#chbIcon').checked(),
            showCount = $('#chbCount').checked(),
            showDesc = $('#chbDesc').checked(),
            showButton = $('#chbButton').checked(),
            showMove = $('#chbMove').checked(),
            showSearch = $('#chbSearch').checked(),
            showTitle = $('#chbTitle').checked(),
            showInfo = $('#chbInfo').checked(),
            moveAble = $('#chbMoveAble').checked(),
            dragAble = $('#chbDragAble').checked(),
            switchIcon = $('#ddlSwitch').val(),
            clickExpand = $('#chbClickExpand').checked(),
            clickChecked = $('#chbClickChecked').checked(),
            dynamicCamera = $('#chbCamera').checked();

        if ($.isObject(data) && data.units) {
            data.units[0].desc = new Date().getTime();
            data.units[0].showType = true;
            //data.units[0].icon = {path: 'imgs/tree/area.png'};
        }
        $.tree(TreeId, {
            skin: skin, 
            async: true, 
            keepStatus: keepStatus,
            keepCookie: keepCookie,
            debug: true,
            trees: trees,
            data: data,
            switch: switchIcon,
            leaf: true,
            leafType: 'camera',
            dynamic: 3,
            //dynamic: true,
            //指定要动态加载子节点的数据类型
            dynamicTypes: ['device', 'camera'],
            //指定为被动态加载的数据类型
            dynamicDatas: dynamicCamera ? 'camera' : '',
            //指定可选中/返回的数据类型，若未指定，则所有都可返回
            returnTypes: ['unit', 'device', 'camera'],
            //返回的数据值字段
            valueFields: ['type', 'id', 'code'],
            //openLevel: 1,
            //openType: 'unit',
            openLevel: openLevel,
            //checkbox: true,
            showCheck: showCheck,
            showIcon: showIcon,
            showCount: showCount,
            showDesc: showDesc,
            showButton: showButton,
            showMove: showMove,
            moveAble: moveAble,
            dragAble: dragAble,
            buttonConfig: {
                types: ['unit','device','camera']
                //types: ['camera']
            },
            showTitle: showTitle,
            showInfo: showInfo,
            showSearch: showSearch,
            /*searchCallback: function (tree, keywords, resolve) {
                var nodes = [], j = 0;
                for (var k in tree.cache.nodes) {
                    var n = tree.cache.nodes[k];
                    if (n.data.name.indexOf(keywords) > -1) {
                        nodes.push(n);
                        j++;
                    }
                    if (j > 5) {
                        break;
                    }
                }
                resolve(tree, nodes);
            },*/
            //showType: false,
            //showStatus: false,
            clickExpand: clickExpand,
            clickChecked: clickChecked,
            callbackLevel: 1,
            complete: function (tree) {
                $('#divOper').show();

                console.log('$.tree(undefined):', $.tree());
                console.log('$.tree(0):', $.tree(0));
                console.log('$.tree(1):', $.tree(1));
                console.log('$.tree(2):', $.tree(2));

                html.push('finish: ' + new Date().format('HHmmss.fff') + '<br />');
                console.log('complete:', tree.id, tree.cache);
                $('#txt').html(html.concat([
                    'nodes:', tree.cache.count, ', level:', tree.cache.level, ', timeout:', tree.cache.timeout, 'ms'
                ]).join(''));
                /*
                window.setTimeout(function() {
                    tree.updateIcon('7280,7155', 'device', {status:'off'});
                    tree.icon('device_7151', {status:'off'});
                    $.tree(TreeId).updateIcon('7759', 'camera', {status:'play'});
                    $.tree.updateIcon(TreeId, '7760', 'camera', {status:'play'});
                    tree.text('device_7153', '204488设备');
                }, 10);
                
                window.setTimeout(function() {
                    tree.selected(['unit_826', 'unit_343', 'unit_780'], true)
                        .checked(['unit_826', 'unit_343'])
                        //.position('unit_343')
                        //.collapse(2, 'unit');
                }, 20);
                
                window.setTimeout(function() {
                    tree//.selected([826, 343, 780], 'unit', true)
                        .checked(['unit_826', 'unit_343'])
                        .expand(2, 'unit')
                        //.position('unit_567', true)
                        //.collapse(2, 'unit');
                }, 20);
                */

                //window.setTimeout(function() { tree.expandType('unit', true, true); }, 200);
                //window.setTimeout(function() { tree.collapseType('device', true); }, 20);

                //window.setTimeout(function() { $.tree.expandAll(TreeId); }, 20);
                //window.setTimeout(function() { tree.expandAll(); }, 20);
                //window.setTimeout(function() { tree.collapseAll(); }, 20);

                //window.setTimeout(function() { $.tree.expand(TreeId, 290, 'unit'); }, 20);
                //window.setTimeout(function() { tree.expand(190, 'unit'); }, 20);

                //window.setTimeout(function() { tree.expandLevel(2, true, true); }, 20);
            },
            callback: function () {

            },
            onclick: function (node, tree, ev) {
                node.self();
                if (!cache['node']) {
                    cache['node'] = node;
                } else {
                    cache['node'].self();
                }

                $.console.log('onclick', tree.id, ev, node, node.childs);
                
                $.console.log('getChecked0:', tree.getChecked());
                $.console.log('getChecked1:', tree.getChecked('data'));
                $.console.log('getChecked2:', tree.getChecked('value'));
                $.console.log('getChecked3:', tree.getChecked('value', 'device'));
                $.console.log('getValue0:', tree.getValue());
                $.console.log('getValue1:', tree.getValue('value'));
                $.console.log('getValue2:', tree.getValue('data'));
                $.console.log('getValue3:', tree.getValue('node'));
                
            },
            ondblclick: function (node, tree, ev) {
                $.console.log('ondblclick', tree.id, ev, node);
            },
            oncontextmenu: function (node, tree, ev) {
                $.console.log('oncontextmenu', tree.id, ev, node);
                if (node) {
                    $.cmenu({
                        id: 'nodemenu',
                        obj: 'tree',
                        width: 150,
                        items: [
                            { name: '新增子目录', func: function () { } },
                        ]
                    }).show(ev);
                } else {
                    $.cmenu({
                        id: 'treemenu',
                        obj: 'tree',
                        width: 150,
                        items: [
                            { name: '展开至一级', func: function () { tree.expandToLevel(0); } },
                            { name: '展开至二级', func: function () { tree.expandToLevel(1); } },
                            { name: '展开所有目录', func: function () { tree.expandToType('unit'); } },
                            { name: '收缩至一级', func: function () { tree.collapseToLevel(1); } },
                            { name: '收缩至二级', func: function () { tree.collapseToLevel(2); } },
                            { sep: 1 },
                            { name: '全部展开', func: function () { tree.expandAll(); } },
                            { name: '全部收缩', func: function () { tree.collapseAll(); } },
                        ]
                    }).show(ev);
                }
            },
            onchecked: function (node, tree) {
                $.console.log('onchecked:', tree.id, node);
            },
            //onexpand: function (node, tree, resolve) {
            onexpand: function (node, tree, resolve, reject) {
                $.console.log('onexpand:', tree.id, node, node.childs);
                if (!node.hasChild()) {
                    if (node.type === 'device') {
                        var cameras = [];
                        var pid = node.data.id;
                        for (var i = 0; i < 2; i++) {
                            cameras.push({id: pid + '_' + (i + 1), name:'监控点' + (i + 1), pid: pid });
                        }

                        //tree.add(cameras, {type:'camera', ptype:'device'});
                        if ($.isFunction(resolve)) {
                            //resolve(cameras, {type: 'camera'});
                            resolve(cameras, 'camera');
                        }
                    } else if (node.type === 'camera') {
                        var presets = [];
                        var pid = node.data.id;
                        for (var i = 0; i < 3; i++) {
                            presets.push({id: pid + '_' + (i + 1), name:'预置点' + (i + 1), pid: pid });
                        }
                        if ($.isFunction(resolve)) {
                            resolve(presets, 'preset');
                        }
                    }
                }
            },
            /*expandCallback: function (node, tree) {
                $.console.log('expandCallback:', tree.id, node);
            },
            */
            buttonCallback: function (node, tree, ev, key) {
                $.console.log('buttonCallback:', tree.id, node, key);
                var pid = node.data.id,
                    par = {type: 'preset', ptype: 'camera'},
                    items = [],
                    num = node.childs.length,
                    len = $('#txtPresetLen').val().toInt(1);

                switch(key) {
                case 'add':                    
                    if (node.type === 'camera') {
                        for (var i = 0; i < len; i++) {
                            items.push({id: pid + '_' + (num + i + 1), name: '预置点' + (num + i + 1), pid: pid});
                        }
                        $.tree(TreeId).add(items, par).expand(node);
                    }
                    break;
                case 'edit':
                    break;
                case 'del':
                    $.tree(TreeId).del(node);
                    break;
                case 'up':
                case 'down':
                    var num = key === 'up' ? -1 : 1;
                    $.tree(TreeId).sortIndex(node, num, function(node, num, idx) {
                        $.console.log('sortIndex:', node.id, key, num, idx);
                    });
                    break;
                }
            },
            onbutton: function (node, tree, ev, key) {

            }
        });
        $.console.log('test finish:');

        $.tree('tree1', {
            skin: skin, 
            data: testData1
        });
    }
  
</script>